<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Directions service</title>
    <style>
      #map-canvas {
	    position: absolute;
	    top: 5px;
		left: 300px;
        height: 700px;
		width: 700px;
        margin: 0px;
        padding: 0px
      }
	  #copyright_notice {
	    position: absolute;
		top: 1px;
	  }
      #panel {
        position: absolute;
        top: 25px;    
        width: 280px;		
        /* margin-left: -180px; */
        /* z-index: 5; */
        background-color: #fff;
        padding: 1px;
        border: 1px solid #999;
      }
	  #steps {
	    position: relative;
		top: 15px;
	  }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script>
var directionsDisplay;
var directionsService = new google.maps.DirectionsService();
var map;

var rad = function(x) {
  return x * Math.PI / 180;
};

var getDistance = function(p1, p2) {
  var R = 6378137; // Earthâ€™s mean radius in meter
  var dLat = rad(p2.lat() - p1.lat());
  var dLong = rad(p2.lng() - p1.lng());
  var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(rad(p1.lat())) * Math.cos(rad(p2.lat())) *
    Math.sin(dLong / 2) * Math.sin(dLong / 2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  var d = R * c;
  return d; // returns the distance in meter
};

function initialize() {
  directionsDisplay = new google.maps.DirectionsRenderer();
  var chicago = new google.maps.LatLng(41.850033, -87.6500523);
  var mapOptions = {
    zoom:7,
    center: chicago
  };
  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  directionsDisplay.setMap(map);
}

function calcRoute() {
  var start = new google.maps.LatLng(46.2000, 6.1500);//document.getElementById('start').value;
  var end = new google.maps.LatLng(46.9500, 7.4500);//document.getElementById('end').value;
  var request = {
      origin:start,
      destination:end,
      travelMode: google.maps.TravelMode.DRIVING
  };
  directionsService.route(request, function(response, status) {
    if (status == google.maps.DirectionsStatus.OK) {
	  var previousLocation = null;
	  clearSteps();
	  $('#steps').append('<table id="steps_table"></table>');
	  for (var i = 0; i < response.routes.length; i++) {
	    var route = response.routes[i];
		document.getElementById('copyright_notice').innerHTML = route.copyrights;
		//console.log(route.legs);
		for (var j = 0; j < route.legs.length; j++) {
		  var steps = route.legs[j].steps;
		  for (var si = 0; si < steps.length; si++) {
		    //console.log(steps[si]);
		    var start_location = steps[si].start_location;
			//if (previousLocation !== null) {
			    if (previousLocation === null || getDistance(previousLocation, start_location) > 10000) {
				  console.log(start_location.lng() + ", " + start_location.lat() + " --> " + previousLocation);
				  $.getJSON('http://api.openweathermap.org/data/2.5/find?lat=' + 
				  start_location.lat() + '&lon=' + start_location.lng() + '&cnt=1', function(data) {
			  
				  var weather = data.list[0].weather[0];
				  //console.log(weather);
				  $('#steps_table').append('<tr><td>' + data.list[0].name + ' <img src="http://openweathermap.org/img/w/' + weather.icon + '.png"/></td></tr>');
				  //var obj = JSON.parse(data);			  				  
				  });
				  previousLocation = start_location;
				}			
			
		    //$('#steps_table').append('<tr><td>' + start_location.lat() + '</td></tr>');
		    //console.log(steps[si].start_location);
			//}
		  }
		  //console.log(route.legs[j]);
		}
	  }
	  //console.log(response.routes);
      directionsDisplay.setDirections(response);
    }
  });
}

function clearSteps() {
  $('#steps_table').remove();
}



google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <div id="copyright_notice"></div>
    <div id="panel">
	  <button onclick="calcRoute();">Calc</button>
	  <div id="steps">
	  </div>
	</div>
    <div id="map-canvas"></div>
  </body>
</html>